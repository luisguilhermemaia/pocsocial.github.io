<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Luxair Social Login PoC</title>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1"
    />

    <!-- Google Identity Services -->
    <script
      src="https://accounts.google.com/gsi/client"
      async
      defer
    ></script>

    <style>
      :root {
        --lx-primary: #005c7a;
        --lx-primary-dark: #004059;
        --lx-accent: #ff4f6d;
        --lx-light: #f5fbff;
        --lx-hero-bg: #e5f3f9;
        --card-bg: #ffffff;
        --border: #d1d5db;
        --text-main: #123047;
        --text-muted: #6b7280;
        --radius-lg: 20px;
        --radius-xl: 24px;
        --shadow-md: 0 14px 40px rgba(15, 23, 42, 0.22);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: linear-gradient(to bottom, #ffffff, var(--lx-light));
        color: var(--text-main);
        display: flex;
        align-items: stretch;
        justify-content: center;
      }

      .page {
        width: 100%;
        max-width: 540px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        background: #ffffff;
      }

      /* MAIN / HERO */
      .lx-main {
        flex: 1;
        background: var(--lx-hero-bg);
        display: flex;
        flex-direction: column;
        padding-bottom: 20px;
      }

      .lx-hero {
        position: relative;
        padding: 24px 16px 120px;
        overflow: hidden;
      }

      .lx-hero-inner {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
      }

      .lx-hero-title {
        font-size: 28px;
        letter-spacing: 0.04em;
        color: var(--lx-primary-dark);
      }

      /* MyLuxair toggle bar */

      .lx-auth-toggle {
        display: inline-grid;
        grid-template-columns: 1fr 1fr;
        border-radius: 999px;
        border: 1px solid #d0e3ee;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
      }

      .lx-auth-toggle button {
        border: none;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 0;
        font-size: 14px;
        min-width: 120px;
        font-weight: 500;
        cursor: pointer;
        color: var(--lx-primary-dark);
      }

      .lx-auth-toggle button:first-child {
        border-right: 1px solid #d0e3ee;
      }

      .lx-auth-toggle button.active {
        background: #005c7a;
        color: #ffffff;
      }

      /* AUTH PANEL */

      .lx-auth-panel {
        position: relative;
        margin: -70px 16px 0;
        padding-bottom: 16px;
      }

      .lx-auth-card {
        width: 100%;
        background: var(--card-bg);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        padding: 16px 14px 18px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .lx-auth-subtitle {
        margin: 2px 0 0;
        text-align: center;
        font-size: 12px;
        color: var(--text-muted);
      }

      .google-area {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      #googleButton {
        display: inline-flex;
        align-self: center;
      }

      .hint {
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
      }

      .signed-in-info {
        margin-top: 4px;
        font-size: 12px;
        color: var(--lx-primary-dark);
        text-align: center;
      }

      .signed-in-info strong {
        font-weight: 600;
      }

      .divider {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0 0;
      }

      .divider-line {
        flex: 1;
        height: 1px;
        background: var(--border);
      }

      .divider-text {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-muted);
      }

      .providers-row {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 6px;
      }

      .provider-btn {
        width: 100%;
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #f9fafb;
        font-size: 14px;
        color: var(--text-main);
        text-decoration: none;
        cursor: pointer;
        transition: background 0.15s ease, transform 0.08s ease,
          box-shadow 0.1s ease;
      }

      .provider-btn span.icon {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
      }

      .provider-btn.apple span.icon {
        background: #111827;
        color: #ffffff;
        font-size: 15px;
      }

      .provider-btn.facebook span.icon {
        background: #1877f2;
        color: #ffffff;
        font-size: 15px;
      }

      .provider-btn.microsoft span.icon {
        background: #ffffff;
        border: 1px solid #d1d5db;
        color: transparent;
        position: relative;
      }

      .provider-btn.microsoft span.icon::before,
      .provider-btn.microsoft span.icon::after {
        content: "";
        position: absolute;
        width: 46%;
        height: 46%;
      }

      .provider-btn.microsoft span.icon::before {
        top: 2px;
        left: 2px;
        background: #f25022;
        box-shadow: 0 50% 0 0 #00a4ef;
      }

      .provider-btn.microsoft span.icon::after {
        top: 2px;
        left: 52%;
        background: #7fba00;
        box-shadow: 0 50% 0 0 #ffb900;
      }

      .provider-btn:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
      }

      .provider-btn:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .status {
        margin-top: 10px;
        padding: 8px 10px;
        border-radius: 12px;
        background: #f9fafb;
        border: 1px dashed var(--border);
        font-size: 12px;
        color: var(--text-muted);
      }

      .status-strong {
        font-weight: 600;
        color: var(--text-main);
      }

      .footer-note {
        margin: 0;
        margin-top: 4px;
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
      }

      .footer-note strong {
        font-weight: 600;
      }

      @media (max-width: 420px) {
        .lx-hero {
          padding: 20px 12px 110px;
        }

        .lx-auth-card {
          border-radius: 18px;
        }
      }
    </style>

    <script>
      let currentMode = "login";
      let currentGoogleUser = null;
      const defaultRedirect = "luxair://social-login-poc";

      function getSearchParams() {
        try {
          return new URLSearchParams(window.location.search);
        } catch (error) {
          console.error("[PoC] Failed to parse search params", error);
          return new URLSearchParams();
        }
      }

      function getRedirectUri() {
        try {
          const url = new URL(window.location.href);
          const fromQuery = url.searchParams.get("redirect_uri");
          return fromQuery || defaultRedirect;
        } catch (error) {
          console.error("[PoC] Failed to parse redirect_uri, using default.", error);
          return defaultRedirect;
        }
      }

      function buildRedirectUrl(payload) {
        const redirectUri = getRedirectUri();
        try {
          const redirect = new URL(redirectUri);
          redirect.searchParams.set(
            "status",
            payload?.type === "LOGIN_SUCCESS" ? "success" : "error"
          );
          if (payload?.provider) redirect.searchParams.set("provider", payload.provider);
          if (payload?.token) redirect.searchParams.set("token", payload.token);
          if (payload?.mode) redirect.searchParams.set("mode", payload.mode);
          if (payload?.mock !== undefined)
            redirect.searchParams.set("mock", payload.mock ? "true" : "false");

          return redirect.toString();
        } catch (error) {
          console.error("[PoC] Failed to build redirect URL, using fallback.", error);
          return redirectUri;
        }
      }

      function redirectBackWithLogout(provider) {
        const baseRedirect = getRedirectUri();
        try {
          const redirect = new URL(baseRedirect);
          redirect.searchParams.set("status", "logout");
          if (provider) redirect.searchParams.set("provider", provider);

          window.location.href = redirect.toString();
        } catch (error) {
          console.error("[PoC] Failed to build logout redirect", error);
          window.location.href = baseRedirect;
        }
      }

      function triggerGoogleLogout() {
        const redirectUri = getRedirectUri();
        const provider = "google";

        // After Google logout, come back to this page and immediately deep link back to the app.
        const returnTo = `${window.location.origin}${window.location.pathname}?logout_done=1&redirect_uri=${encodeURIComponent(
          redirectUri
        )}&provider=${encodeURIComponent(provider)}`;

        // Google is picky about the continue target; use the double-continue pattern via appengine logout.
        const googleLogoutUrl = `https://accounts.google.com/Logout?continue=${encodeURIComponent(
          `https://appengine.google.com/_ah/logout?continue=${encodeURIComponent(returnTo)}`
        )}`;

        updateStatus("Signing out from Google…");
        window.location.href = googleLogoutUrl;
      }

      function postToReactNative(payload) {
        const target = buildRedirectUrl(payload);
        const stringified = JSON.stringify({ ...payload, redirect: target });

        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(stringified);
        } else {
          console.log("[PoC] Web payload (no RN bridge):", stringified);
        }

        window.location.href = target;
      }

      function updateStatus(message) {
        const statusEl = document.getElementById("status");
        if (statusEl) {
          statusEl.textContent = message;
        }
      }

      function updateSignedInInfo(user) {
        const infoEl = document.getElementById("signedInInfo");
        if (!infoEl) return;

        if (!user) {
          infoEl.style.display = "none";
          infoEl.textContent = "";
          return;
        }

        const label = user.name || user.email || "Google user";
        infoEl.style.display = "block";
        infoEl.innerHTML = `Signed in as <strong>${label}</strong>`;
      }

      // Basic JWT decode for ID token (front-end only, for display)
      function decodeJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (error) {
          console.warn("[PoC] Failed to decode JWT:", error);
          return null;
        }
      }

      // GOOGLE (real, using Google Identity Services)
      function handleCredentialResponse(response) {
        try {
          const decoded = decodeJwt(response.credential);

          currentGoogleUser = decoded
            ? {
                email: decoded.email,
                name: decoded.name || decoded.given_name,
                sub: decoded.sub,
              }
            : null;

          const payload = {
            type: "LOGIN_SUCCESS",
            provider: "google",
            token: response.credential,
            mode: currentMode, // "login" or "signup"
            mock: false,
            profile: currentGoogleUser,
          };

          postToReactNative(payload);
          updateStatus(
            `Google ${currentMode} successful. Token sent to the app.`
          );
          updateSignedInInfo(currentGoogleUser);

          console.log("[PoC] Google login success:", {
            provider: payload.provider,
            mode: payload.mode,
            profile: payload.profile,
            tokenPreview: payload.token?.slice(0, 16) + "...",
          });
        } catch (error) {
          console.error("[PoC] Error handling Google credential:", error);
          updateStatus("An error occurred while processing Google login.");
        }
      }

      // OTHER PROVIDERS (mock for now)
      function handleProviderClick(provider) {
        try {
          const payload = {
            type: "LOGIN_SUCCESS",
            provider,
            mode: currentMode,
            token: null,
            mock: true,
          };

          postToReactNative(payload);
          updateStatus(
            `${capitalize(provider)} (mock, ${currentMode}) login triggered and sent to the app.`
          );

          console.log("[PoC] Mock login for provider:", payload);
        } catch (error) {
          console.error("[PoC] Error handling provider click:", error);
          updateStatus("An error occurred while triggering the login.");
        }
      }

      function handleMockLogout() {
        // Removed mock logout; Google logout is the only path we expose now.
        updateStatus("Mock logout is disabled. Use Google logout instead.");
      }

      function handlePageArrival() {
        try {
          const params = new URLSearchParams(window.location.search);
          const logoutDone = params.get("logout_done");
          const action = params.get("action");

          if (logoutDone) {
            const provider = params.get("provider") || "google";
            history.replaceState(null, "", window.location.pathname);
            updateStatus(`Logout completed for ${provider}. Redirecting back to the app…`);
            redirectBackWithLogout(provider);
            return true;
          }

          if (action === "logout") {
            history.replaceState(null, "", window.location.pathname);
            triggerGoogleLogout();
            return true;
          }
        } catch (error) {
          console.error("[PoC] Failed to handle arrival params", error);
        }

        return false;
      }

      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function initGoogleButton() {
        if (!window.google || !google.accounts || !google.accounts.id) {
          console.warn("[PoC] Google Identity API not loaded yet");
          updateStatus(
            "Waiting for Google Identity API to load. Please try again in a moment."
          );
          return;
        }

        google.accounts.id.initialize({
          client_id:
            "45303054578-5v4ar40o31vfne9rafja4vc0988ja60c.apps.googleusercontent.com",
          callback: handleCredentialResponse,
        });

        google.accounts.id.renderButton(
          document.getElementById("googleButton"),
          {
            theme: "outline",
            size: "large",
            type: "standard",
            shape: "rectangular",
            text: "continue_with",
          }
        );

        updateStatus("Ready. Choose a provider to start the PoC.");
      }

      function setupToggle() {
        const signupBtn = document.getElementById("toggle-signup");
        const loginBtn = document.getElementById("toggle-login");
        const subtitle = document.getElementById("auth-subtitle");

        if (!signupBtn || !loginBtn || !subtitle) return;

        signupBtn.addEventListener("click", () => {
          currentMode = "signup";
          signupBtn.classList.add("active");
          loginBtn.classList.remove("active");
          subtitle.textContent =
            "For this PoC we focus on the login experience, but you can test social sign-up here as well.";
        });

        loginBtn.addEventListener("click", () => {
          currentMode = "login";
          loginBtn.classList.add("active");
          signupBtn.classList.remove("active");
          subtitle.textContent =
            "Choose one of the options below to access your MyLuxair account (PoC).";
        });
      }

      window.addEventListener("load", function () {
        if (handlePageArrival()) return;

        updateStatus("Loading Google Identity Services…");
        setupToggle();

        if (window.google && google.accounts && google.accounts.id) {
          initGoogleButton();
        } else {
          const intervalId = setInterval(function () {
            if (window.google && google.accounts && google.accounts.id) {
              clearInterval(intervalId);
              initGoogleButton();
            }
          }, 300);

          setTimeout(function () {
            clearInterval(intervalId);
            if (!window.google || !google.accounts || !google.accounts.id) {
              console.warn("[PoC] Google Identity API failed to load in time");
              updateStatus(
                "Google Identity API could not be loaded. Please refresh the page."
              );
            }
          }, 8000);
        }
      });
    </script>
  </head>

  <body>
    <div class="page">
      <main class="lx-main">
        <section class="lx-hero" aria-label="MyLuxair hero">
          <div class="lx-hero-inner">
            <h1 class="lx-hero-title">MyLuxair</h1>

            <div class="lx-auth-toggle">
              <button id="toggle-signup" type="button">Sign-up</button>
              <button id="toggle-login" type="button" class="active">
                Login
              </button>
            </div>
          </div>
        </section>

        <section class="lx-auth-panel">
          <div class="lx-auth-card" aria-label="MyLuxair login PoC">
            <p id="auth-subtitle" class="lx-auth-subtitle">
              Choose one of the options below to access your MyLuxair account
              (PoC).
            </p>

            <section class="google-area">
              <div id="googleButton"></div>
              <p class="hint">
                Recommended for this PoC: Google Sign-In (real Google Identity
                Services flow).
              </p>
              <p
                id="signedInInfo"
                class="signed-in-info"
                style="display: none;"
              ></p>
            </section>

            <div class="divider">
              <div class="divider-line"></div>
              <span class="divider-text">Or continue with</span>
              <div class="divider-line"></div>
            </div>

            <section class="providers-row">
              <button
                class="provider-btn apple"
                type="button"
                onclick="handleProviderClick('apple')"
              >
                <span class="icon"></span>
                <span>Continue with Apple (mock)</span>
              </button>

              <button
                class="provider-btn facebook"
                type="button"
                onclick="handleProviderClick('facebook')"
              >
                <span class="icon">f</span>
                <span>Continue with Facebook (mock)</span>
              </button>

              <button
                class="provider-btn microsoft"
                type="button"
                onclick="handleProviderClick('microsoft')"
              >
                <span class="icon"></span>
                <span>Continue with Microsoft (mock)</span>
              </button>
            </section>

            <section class="providers-row">
              <button class="provider-btn" type="button" onclick="triggerGoogleLogout()">
                <span class="icon">G</span>
                <span>Logout Google</span>
              </button>
            </section>

            <section class="status">
              <span class="status-strong">Status:</span>
              <span id="status">Initializing PoC…</span>
            </section>

            <p class="footer-note">
              This screen is for <strong>technical demonstration only</strong>.
              Google uses a real token; other providers are mocked and just
              simulate a successful login event to the app, including the
              selected mode (login/sign-up).
            </p>
          </div>
        </section>
      </main>
    </div>
  </body>
</html>
